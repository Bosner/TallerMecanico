{% extends 'base.html' %}
{% block content %}

<h2 class="mb-4">Órdenes de Trabajo</h2>

<!-- Dashboard rápido -->
<div class="row mb-4 g-3">
    <div class="col-md-3">
        <div class="card text-white bg-warning shadow-sm">
            <div class="card-body text-center">
                <h5 class="card-title">Pendientes</h5>
                <p class="card-text display-5 fw-bold">{{ total_pendientes }}</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-info shadow-sm">
            <div class="card-body text-center">
                <h5 class="card-title">En Progreso</h5>
                <p class="card-text display-5 fw-bold">{{ total_progreso }}</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-success shadow-sm">
            <div class="card-body text-center">
                <h5 class="card-title">Completadas Hoy</h5>
                <p class="card-text display-5 fw-bold">{{ total_completadas_hoy }}</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-secondary shadow-sm">
            <div class="card-body text-center">
                <h5 class="card-title">Abiertas</h5>
                <p class="card-text display-5 fw-bold">{{ total_abiertas }}</p>
            </div>
        </div>
    </div>
</div>

<!-- Filtros -->
<form method="GET" class="mb-4 border p-3 rounded bg-light">
    <div class="row g-3">
        <div class="col-md-4">
            <label for="estado" class="form-label fw-bold">Estado</label>
            <select class="form-select" id="estado" name="estado">
                <option value="todas" {% if estado_filtro == 'todas' %}selected{% endif %}>Todas</option>
                <option value="Pendiente" {% if estado_filtro == 'Pendiente' %}selected{% endif %}>Pendiente</option>
                <option value="En progreso" {% if estado_filtro == 'En progreso' %}selected{% endif %}>En progreso</option>
                <option value="Completado" {% if estado_filtro == 'Completado' %}selected{% endif %}>Completado</option>
                <option value="Cancelado" {% if estado_filtro == 'Cancelado' %}selected{% endif %}>Cancelado</option>
            </select>
        </div>
        <div class="col-md-6">
            <label for="busqueda" class="form-label fw-bold">Buscar por placa o cliente</label>
            <input type="text" class="form-control" id="busqueda" name="busqueda" 
                   value="{{ busqueda }}" placeholder="Ej: ABC123 o Juan Pérez">
        </div>
        <div class="col-md-2 d-flex align-items-end">
            <button type="submit" class="btn btn-primary w-100">Filtrar</button>
        </div>
    </div>
</form>

<!-- Botón para crear nueva orden (opcional: podrías mover el form a un modal) -->
<button class="btn btn-lg btn-success mb-4" type="button" data-bs-toggle="collapse" data-bs-target="#formNuevaOrden" aria-expanded="false" aria-controls="formNuevaOrden">
    + Nueva Orden de Trabajo
</button>

<!-- Formulario de creación (colapsable para no ocupar siempre espacio) -->
<div class="collapse mb-5" id="formNuevaOrden">
    <form method="POST" id="ordenForm" class="border p-4 rounded bg-light shadow-sm">
        <h4 class="mb-4">Crear nueva orden</h4>
        
        <div class="row g-3">
            <div class="col-md-6">
                <label for="vehiculo_id" class="form-label fw-bold">Vehículo *</label>
                <select class="form-select" id="vehiculo_id" name="vehiculo_id" required>
                    <option value="">Selecciona vehículo</option>
                    {% for v in vehiculos %}
                    <option value="{{ v.id }}">{{ v.marca }} {{ v.modelo }} — Placa: {{ v.placa }} ({{ v.cliente.nombre }})</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="col-12">
                <label for="descripcion" class="form-label fw-bold">Descripción del trabajo *</label>
                <textarea class="form-control" id="descripcion" name="descripcion" rows="4" required placeholder="Ej: Cambio de pastillas de freno delanteras, revisión de suspensión..."></textarea>
            </div>
            
            <div class="col-md-4">
                <label for="costo_mano_obra" class="form-label fw-bold">Costo Mano de Obra *</label>
                <div class="input-group">
                    <span class="input-group-text">$</span>
                    <input type="number" step="0.01" min="0" class="form-control" id="costo_mano_obra" name="costo_mano_obra" required>
                </div>
            </div>
        </div>

        <!-- Partes usadas (dinámico) -->
        <div class="mt-4">
            <h5>Partes / Materiales Usados</h5>
            <div id="partesContainer">
                <div class="row g-3 parte-fila mb-3 align-items-end">
                    <div class="col-md-5">
                        <label class="form-label">Parte</label>
                        <select class="form-select" name="parte_id[]">
                            <option value="">-- Ninguna --</option>
                            {% for p in partes %}
                            <option value="{{ p.id }}">{{ p.nombre_parte }} (Stock: {{ p.cantidad }}) — ${{ p.precio }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Cantidad</label>
                        <input type="number" class="form-control" name="cantidad_usada[]" min="1" value="1">
                    </div>
                    <div class="col-md-2">
                        <button type="button" class="btn btn-danger btn-sm remove-fila mt-4">Eliminar</button>
                    </div>
                </div>
            </div>

            <button type="button" id="addParte" class="btn btn-outline-success mt-2">
                + Agregar otra parte
            </button>
        </div>

        <div class="mt-4">
            <button type="submit" class="btn btn-primary btn-lg px-5">Crear Orden</button>
        </div>
    </form>
</div>

<!-- Tabla principal -->
<div class="table-responsive">
    <table class="table table-striped table-hover table-bordered">
        <thead class="table-dark">
            <tr>
                <th>ID</th>
                <th>Fecha</th>
                <th>Vehículo / Placa</th>
                <th>Cliente</th>
                <th>Descripción</th>
                <th>Costo MO</th>
                <th>Partes</th>
                <th>Estado</th>
                <th>Acción</th>
            </tr>
        </thead>
        <tbody>
            {% for orden in ordenes %}
            <tr class="{% if orden.estado == 'Pendiente' %}table-warning
                       {% elif orden.estado == 'En progreso' %}table-info
                       {% elif orden.estado == 'Completado' %}table-success
                       {% elif orden.estado == 'Cancelado' %}table-secondary{% endif %}">
                <td>{{ orden.id }}</td>
                <td>{{ orden.fecha_creacion.strftime('%d/%m/%Y') }}</td>
                <td>
                    {{ orden.vehiculo.marca }} {{ orden.vehiculo.modelo }}<br>
                    <small class="text-muted">Placa: {{ orden.vehiculo.placa }}</small>
                </td>
                <td>{{ orden.vehiculo.cliente.nombre }}</td>
                <td>{{ orden.descripcion|truncate(60) }}</td>
                <td class="text-end">${{ orden.costo_mano_obra|round(2) }}</td>
                <td class="text-center">
                    {% if orden.partes.count() > 0 %}
                        <span class="badge bg-primary">{{ orden.partes.count() }}</span>
                    {% else %}
                        <span class="badge bg-secondary">-</span>
                    {% endif %}
                </td>
                <td class="text-center">
                    <span class="badge fs-6 {% if orden.estado == 'Pendiente' %}bg-warning text-dark
                                       {% elif orden.estado == 'En progreso' %}bg-info
                                       {% elif orden.estado == 'Completado' %}bg-success
                                       {% else %}bg-danger{% endif %}">
                        {{ orden.estado }}
                    </span>
                </td>
                <td class="text-center">
                    <a href="{{ url_for('detalle_orden', orden_id=orden.id) }}" 
                       class="btn btn-sm btn-primary">Ver / Editar</a>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="9" class="text-center py-5 text-muted">
                    No hay órdenes que coincidan con los filtros actuales
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Paginación -->
{% if paginacion.has_prev or paginacion.has_next %}
<nav aria-label="Paginación de órdenes">
    <ul class="pagination justify-content-center mt-4">
        <li class="page-item {% if not paginacion.has_prev %}disabled{% endif %}">
            <a class="page-link" href="?page={{ paginacion.prev_num }}&estado={{ estado_filtro }}&busqueda={{ busqueda }}">Anterior</a>
        </li>
        {% for p in paginacion.iter_pages(left_edge=2, right_edge=3) %}
            {% if p %}
                <li class="page-item {% if p == paginacion.page %}active{% endif %}">
                    <a class="page-link" href="?page={{ p }}&estado={{ estado_filtro }}&busqueda={{ busqueda }}">{{ p }}</a>
                </li>
            {% else %}
                <li class="page-item disabled"><span class="page-link">…</span></li>
            {% endif %}
        {% endfor %}
        <li class="page-item {% if not paginacion.has_next %}disabled{% endif %}">
            <a class="page-link" href="?page={{ paginacion.next_num }}&estado={{ estado_filtro }}&busqueda={{ busqueda }}">Siguiente</a>
        </li>
    </ul>
</nav>
{% endif %}

<!-- JavaScript para partes dinámicas -->
<script>
document.getElementById('addParte')?.addEventListener('click', function() {
    const container = document.getElementById('partesContainer');
    const filaBase = container.querySelector('.parte-fila');
    if (!filaBase) return;

    const nuevaFila = filaBase.cloneNode(true);
    nuevaFila.querySelector('select').value = '';
    nuevaFila.querySelector('input[type="number"]').value = '1';

    nuevaFila.querySelector('.remove-fila').addEventListener('click', function() {
        if (document.querySelectorAll('.parte-fila').length > 1) {
            nuevaFila.remove();
        } else {
            alert('Puedes dejar la fila vacía si no usas partes.');
        }
    });

    container.appendChild(nuevaFila);
});

document.querySelectorAll('.remove-fila').forEach(btn => {
    btn.addEventListener('click', function() {
        if (document.querySelectorAll('.parte-fila').length > 1) {
            this.closest('.parte-fila').remove();
        } else {
            alert('Puedes dejar la fila vacía si no usas partes.');
        }
    });
});
</script>

{% endblock %}