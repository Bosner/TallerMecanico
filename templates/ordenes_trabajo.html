{% extends 'base.html' %}
{% block content %}
<h2>Órdenes de Trabajo</h2>

<!-- Dashboard rápido -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-white bg-warning">
            <div class="card-body">
                <h5 class="card-title">Pendientes</h5>
                <p class="card-text display-6">{{ total_pendientes }}</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-info">
            <div class="card-body">
                <h5 class="card-title">En Progreso</h5>
                <p class="card-text display-6">{{ total_progreso }}</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-success">
            <div class="card-body">
                <h5 class="card-title">Completadas Hoy</h5>
                <p class="card-text display-6">{{ total_completadas_hoy }}</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-secondary">
            <div class="card-body">
                <h5 class="card-title">Abiertas</h5>
                <p class="card-text display-6">{{ total_abiertas }}</p>
            </div>
        </div>
    </div>
</div>

<!-- Filtros -->
<form method="GET" class="mb-4">
    <div class="row g-3">
        <div class="col-md-4">
            <label for="estado" class="form-label">Estado</label>
            <select class="form-select" id="estado" name="estado">
                <option value="todas" {% if estado_filtro == 'todas' %}selected{% endif %}>Todas</option>
                <option value="Pendiente" {% if estado_filtro == 'Pendiente' %}selected{% endif %}>Pendiente</option>
                <option value="En progreso" {% if estado_filtro == 'En progreso' %}selected{% endif %}>En progreso</option>
                <option value="Completado" {% if estado_filtro == 'Completado' %}selected{% endif %}>Completado</option>
                <option value="Cancelado" {% if estado_filtro == 'Cancelado' %}selected{% endif %}>Cancelado</option>
            </select>
        </div>
        <div class="col-md-6">
            <label for="busqueda" class="form-label">Buscar por placa o cliente</label>
            <input type="text" class="form-control" id="busqueda" name="busqueda" value="{{ busqueda }}" placeholder="Ej: ABC123 o Juan Pérez">
        </div>
        <div class="col-md-2 d-flex align-items-end">
            <button type="submit" class="btn btn-primary w-100">Filtrar</button>
        </div>
    </div>
</form>

<!-- Tabla de órdenes -->
<div class="table-responsive">
    <table class="table table-striped table-hover">
        <thead class="table-dark">
            <tr>
                <th>ID</th>
                <th>Fecha</th>
                <th>Vehículo / Placa</th>
                <th>Cliente</th>
                <th>Descripción</th>
                <th>Costo MO</th>
                <th>Partes</th>
                <th>Estado</th>
            </tr>
        </thead>
        <tbody>
            {% for orden in ordenes %}
            <tr class="{% if orden.estado == 'Pendiente' %}table-warning
                       {% elif orden.estado == 'En progreso' %}table-info
                       {% elif orden.estado == 'Completado' %}table-success
                       {% elif orden.estado == 'Cancelado' %}table-secondary{% endif %}">
                <td>{{ orden.id }}</td>
                <td>{{ orden.fecha_creacion.strftime('%d/%m/%Y') }}</td>
                <td>{{ orden.vehiculo.marca }} {{ orden.vehiculo.modelo }}<br><small>{{ orden.vehiculo.placa }}</small></td>
                <td>{{ orden.vehiculo.cliente.nombre }}</td>
                <td>{{ orden.descripcion|truncate(60) }}</td>
                <td>${{ orden.costo_mano_obra|round(2) }}</td>
                <td>
                    {% if orden.partes.count() > 0 %}
                        <small>{{ orden.partes.count() }} partes</small>
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td>
                    <span class="badge {% if orden.estado == 'Pendiente' %}bg-warning text-dark
                                       {% elif orden.estado == 'En progreso' %}bg-info
                                       {% elif orden.estado == 'Completado' %}bg-success
                                       {% else %}bg-secondary{% endif %}">
                        {{ orden.estado }}
                    </span>
                </td>
            </tr>
            {% else %}
            <tr><td colspan="8" class="text-center py-4">No hay órdenes que coincidan con los filtros</td></tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Paginación -->
{% if paginacion.has_prev or paginacion.has_next %}
<nav aria-label="Paginación de órdenes">
    <ul class="pagination justify-content-center">
        <li class="page-item {% if not paginacion.has_prev %}disabled{% endif %}">
            <a class="page-link" href="?page={{ paginacion.prev_num }}&estado={{ estado_filtro }}&busqueda={{ busqueda }}">Anterior</a>
        </li>
        {% for p in paginacion.iter_pages(left_edge=2, right_edge=2) %}
            {% if p %}
                <li class="page-item {% if p == paginacion.page %}active{% endif %}">
                    <a class="page-link" href="?page={{ p }}&estado={{ estado_filtro }}&busqueda={{ busqueda }}">{{ p }}</a>
                </li>
            {% else %}
                <li class="page-item disabled"><span class="page-link">...</span></li>
            {% endif %}
        {% endfor %}
        <li class="page-item {% if not paginacion.has_next %}disabled{% endif %}">
            <a class="page-link" href="?page={{ paginacion.next_num }}&estado={{ estado_filtro }}&busqueda={{ busqueda }}">Siguiente</a>
        </li>
    </ul>
</nav>
{% endif %}

<form method="POST" id="ordenForm" class="mb-4 border p-4 rounded bg-light">
    <div class="row g-3">
        <div class="col-md-6">
            <label for="vehiculo_id" class="form-label">Vehículo *</label>
            <select class="form-select" id="vehiculo_id" name="vehiculo_id" required>
                <option value="">Selecciona vehículo</option>
                {% for v in vehiculos %}
                <option value="{{ v.id }}">{{ v.marca }} {{ v.modelo }} - Placa: {{ v.placa }} ({{ v.cliente.nombre }})</option>
                {% endfor %}
            </select>
        </div>
        
        <div class="col-12">
            <label for="descripcion" class="form-label">Descripción del trabajo *</label>
            <textarea class="form-control" id="descripcion" name="descripcion" rows="3" required></textarea>
        </div>
        
        <div class="col-md-4">
            <label for="costo_mano_obra" class="form-label">Costo Mano de Obra *</label>
            <input type="number" step="0.01" class="form-control" id="costo_mano_obra" name="costo_mano_obra" required>
        </div>
    </div>

    <!-- Sección de partes usadas (dinámica) -->
    <div class="mt-4">
        <h5>Partes / Materiales Usados</h5>
        <div id="partesContainer">
            <!-- Fila inicial (opcional, puedes dejarla o empezar vacío) -->
            <div class="row g-3 parte-fila mb-2 align-items-end">
                <div class="col-md-5">
                    <label class="form-label">Parte</label>
                    <select class="form-select" name="parte_id[]">
                        <option value="">-- Ninguna --</option>
                        {% for p in partes %}
                        <option value="{{ p.id }}">{{ p.nombre_parte }} (Stock: {{ p.cantidad }}) - ${{ p.precio }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Cantidad</label>
                    <input type="number" class="form-control" name="cantidad_usada[]" min="1" value="1">
                </div>
                <div class="col-md-2">
                    <button type="button" class="btn btn-danger btn-sm remove-fila">Eliminar</button>
                </div>
            </div>
        </div>

        <button type="button" id="addParte" class="btn btn-success mt-2">
            + Agregar otra parte
        </button>
    </div>

    <div class="mt-4">
        <button type="submit" class="btn btn-primary btn-lg">Crear Orden de Trabajo</button>
    </div>
</form>

<!-- Tabla de órdenes existentes (puedes mejorarla mostrando partes usadas) -->
<h3>Órdenes Existentes</h3>
<table class="table table-striped">
    <thead>
        <tr>
            <th>ID</th>
            <th>Vehículo</th>
            <th>Descripción</th>
            <th>Costo MO</th>
            <th>Partes usadas</th>
            <th>Estado</th>
        </tr>
    </thead>
    <tbody>
        {% for orden in ordenes %}
        <tr>
            <td>{{ orden.id }}</td>
            <td>{{ orden.vehiculo.marca }} {{ orden.vehiculo.modelo }} - {{ orden.vehiculo.placa }}</td>
            <td>{{ orden.descripcion|truncate(60) }}</td>
            <td>${{ orden.costo_mano_obra }}</td>
            <td>
                {% if orden.partes.count() > 0 %}
                    <ul class="mb-0">
                    {% for parte in orden.partes %}
                        <li>{{ parte.nombre_parte }} × {{ parte.cantidad_usada }}</li>  <!-- Nota: cantidad_usada viene de la tabla intermedia -->
                    {% endfor %}
                    </ul>
                {% else %}
                    Ninguna
                {% endif %}
            </td>
            <td>{{ orden.estado }}</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<script>
// JavaScript para agregar/eliminar filas de partes
document.getElementById('addParte').addEventListener('click', function() {
    const container = document.getElementById('partesContainer');
    const filaBase = container.querySelector('.parte-fila');
    
    if (!filaBase) return;
    
    const nuevaFila = filaBase.cloneNode(true);
    
    // Limpiar valores
    nuevaFila.querySelector('select').value = '';
    nuevaFila.querySelector('input[type="number"]').value = '1';
    
    // Agregar evento de eliminar
    nuevaFila.querySelector('.remove-fila').addEventListener('click', function() {
        nuevaFila.remove();
    });
    
    container.appendChild(nuevaFila);
});

// Eliminar filas iniciales (si se clica)
document.querySelectorAll('.remove-fila').forEach(btn => {
    btn.addEventListener('click', function() {
        if (document.querySelectorAll('.parte-fila').length > 1) {
            this.closest('.parte-fila').remove();
        } else {
            alert('Debe haber al menos una fila (puedes dejarla vacía)');
        }
    });
});
</script>

{% endblock %}