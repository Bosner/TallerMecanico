{% extends 'base.html' %}
{% block content %}

<h2 class="mb-4">Órdenes de Servicio</h2>

<!-- Dashboard rápido -->
<div class="row mb-4 g-3">
    <div class="col-md-3">
        <div class="card text-white bg-warning shadow-sm">
            <div class="card-body text-center">
                <h5 class="card-title">Pendientes</h5>
                <p class="card-text display-5 fw-bold">{{ total_pendientes }}</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-info shadow-sm">
            <div class="card-body text-center">
                <h5 class="card-title">En Progreso</h5>
                <p class="card-text display-5 fw-bold">{{ total_progreso }}</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-success shadow-sm">
            <div class="card-body text-center">
                <h5 class="card-title">Completadas Hoy</h5>
                <p class="card-text display-5 fw-bold">{{ total_completadas_hoy }}</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-secondary shadow-sm">
            <div class="card-body text-center">
                <h5 class="card-title">Abiertas</h5>
                <p class="card-text display-5 fw-bold">{{ total_abiertas }}</p>
            </div>
        </div>
    </div>
</div>

<!-- Filtros -->
<form method="GET" class="mb-4 border p-3 rounded bg-light">
    <div class="row g-3">
        <div class="col-md-4">
            <label for="estado" class="form-label fw-bold">Estado</label>
            <select class="form-select" id="estado" name="estado">
                <option value="todas" {% if estado_filtro == 'todas' %}selected{% endif %}>Todas</option>
                <option value="Pendiente" {% if estado_filtro == 'Pendiente' %}selected{% endif %}>Pendiente</option>
                <option value="En progreso" {% if estado_filtro == 'En progreso' %}selected{% endif %}>En progreso</option>
                <option value="Completado" {% if estado_filtro == 'Completado' %}selected{% endif %}>Completado</option>
                <option value="Cancelado" {% if estado_filtro == 'Cancelado' %}selected{% endif %}>Cancelado</option>
            </select>
        </div>
        <div class="col-md-6">
            <label for="busqueda" class="form-label fw-bold">Buscar por placa, cliente o folio</label>
            <input type="text" class="form-control" id="busqueda" name="busqueda" 
                   value="{{ busqueda }}" placeholder="Ej: ABC123, Juan Pérez, F-0123">
        </div>
        <div class="col-md-2 d-flex align-items-end">
            <button type="submit" class="btn btn-primary w-100">Filtrar</button>
        </div>
    </div>
</form>

<!-- Botón para crear nueva orden -->
<button class="btn btn-lg btn-success mb-4" type="button" 
        data-bs-toggle="collapse" data-bs-target="#formNuevaOrden" 
        aria-expanded="false" aria-controls="formNuevaOrden">
    + Nueva Orden de Servicio
</button>

<!-- Formulario de creación (colapsado) -->
<div class="collapse mb-5" id="formNuevaOrden">
    <div class="card border-success">
        <div class="card-header bg-success text-white">
            <h5 class="mb-0">Crear Nueva Orden de Servicio</h5>
        </div>
        <div class="card-body">
            <form method="POST">
                <!-- Cliente y Vehículo -->
                <div class="row g-3 mb-4">
                    <div class="col-md-6">
                        <label for="cliente_id" class="form-label fw-bold">Cliente *</label>
                        <select class="form-select form-select-lg" id="cliente_id" name="cliente_id" 
                                required onchange="cargarVehiculos(this.value)">
                            <option value="">Selecciona un cliente</option>
                            {% for cliente in clientes %}
                            <option value="{{ cliente.id }}">{{ cliente.nombre }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="vehiculo_id" class="form-label fw-bold">Vehículo *</label>
                        <select class="form-select form-select-lg" id="vehiculo_id" name="vehiculo_id" required>
                            <option value="">Primero selecciona el cliente</option>
                        </select>
                    </div>
                </div>

                <!-- Falla reportada -->
                <div class="mb-4">
                    <label for="falla_reportada" class="form-label fw-bold">Falla reportada por el cliente *</label>
                    <textarea class="form-control" id="falla_reportada" name="falla_reportada" rows="3" 
                              placeholder="Ej: No enciende, hace ruido al frenar, pierde aceite..." required></textarea>
                </div>

                <!-- Checklist Revisión Física Inicial -->
                <div class="card shadow mb-4">
                    <div class="card-header bg-light fw-bold">Revisión Física Inicial (SI / NO)</div>
                    <div class="card-body">
                        {% for item in checklist_items %}
                        <div class="row mb-3 align-items-center border-bottom pb-2">
                            <div class="col-md-5">
                                <label class="form-label">{{ item.label }}</label>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" 
                                           name="checklist_si_{{ item.key }}" id="si_{{ item.key }}">
                                    <label class="form-check-label" for="si_{{ item.key }}">SI</label>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <input type="text" class="form-control form-control-sm" 
                                       name="obs_{{ item.key }}" placeholder="Observaciones...">
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Marcado interactivo de daños -->
                <div class="card shadow mb-4">
                    <div class="card-header bg-danger text-white fw-bold">
                        Marcar daños / golpes en el vehículo
                    </div>
                    <div class="card-body">
                        <p class="text-muted mb-3">Toca o haz clic en las zonas donde hay daños. Se pintarán de rojo y podrás agregar una observación.</p>

                        <!-- Pestañas para cambiar vista del carro -->
                        <ul class="nav nav-tabs mb-3" id="vistasCarroTab" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="frente-tab" data-bs-toggle="tab" data-bs-target="#vista-frente" type="button">Frente</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="izquierda-tab" data-bs-toggle="tab" data-bs-target="#vista-izquierda" type="button">Izquierda</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="derecha-tab" data-bs-toggle="tab" data-bs-target="#vista-derecha" type="button">Derecha</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="atras-tab" data-bs-toggle="tab" data-bs-target="#vista-atras" type="button">Atrás</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="arriba-tab" data-bs-toggle="tab" data-bs-target="#vista-arriba" type="button">Arriba</button>
                            </li>
                        </ul>

                        <div class="tab-content mb-4" id="vistasCarroTabContent">
                            <!-- Vista Frente -->
                            <div class="tab-pane fade show active text-center" id="vista-frente">
                                <div class="position-relative d-inline-block">
                                    <img src="{{ url_for('static', filename='img/vehiculo/frente.png') }}" alt="Vista frente" class="img-fluid" style="max-height: 350px;">
                                    <!-- Zonas superpuestas (ajusta top/left/width/height según tu imagen) -->
                                    <div class="danio-zona" data-zona="parachoques_delantero" style="position:absolute; top:70%; left:20%; width:60%; height:15%; cursor:pointer; border:1px dashed #ccc;"></div>
                                    <div class="danio-zona" data-zona="capo" style="position:absolute; top:20%; left:15%; width:70%; height:40%; cursor:pointer; border:1px dashed #ccc;"></div>
                                </div>
                            </div>

                            <!-- Vista Izquierda (ejemplo) -->
                            <div class="tab-pane fade text-center" id="vista-izquierda">
                                <div class="position-relative d-inline-block">
                                    <img src="{{ url_for('static', filename='img/vehiculo/izquierda.png') }}" alt="Vista izquierda" class="img-fluid" style="max-height: 350px;">
                                    <div class="danio-zona" data-zona="puerta_delantera_izq" style="position:absolute; top:35%; left:35%; width:30%; height:35%; cursor:pointer; border:1px dashed #ccc;"></div>
                                    <!-- Agrega más <div class="danio-zona"> según necesites -->
                                </div>
                            </div>

                            <!-- Repite para derecha, atrás y arriba con sus imágenes y posiciones -->
                            <!-- ... -->
                        </div>

                        <!-- Lista de zonas marcadas (se actualiza con JS) -->
                        <div id="zonasMarcadas" class="mt-3">
                            <h6>Zonas con daño marcado:</h6>
                            <ul id="listaZonas" class="list-group"></ul>
                        </div>

                        <!-- Campo oculto para enviar JSON al servidor -->
                        <input type="hidden" name="danios_zonas_json" id="danios_zonas_json">
                    </div>
                </div>

                <!-- Fecha compromiso -->
                <div class="mb-4">
                    <label for="fecha_compromiso" class="form-label fw-bold">Fecha compromiso de entrega (opcional)</label>
                    <input type="date" class="form-control" id="fecha_compromiso" name="fecha_compromiso">
                </div>

                <div class="mt-4 text-end">
                    <button type="submit" class="btn btn-success btn-lg px-5">Crear Orden</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Tabla de órdenes -->
<div class="table-responsive">
    <table class="table table-striped table-hover">
        <thead class="table-dark">
            <tr>
                <th>Folio</th>
                <th>Placa</th>
                <th>Vehículo</th>
                <th>Cliente</th>
                <th>Estado</th>
                <th>Fecha</th>
                <th>Acción</th>
            </tr>
        </thead>
        <tbody>
            {% for orden in ordenes %}
            <tr>
                <td><strong>{{ orden.folio or 'Sin folio' }}</strong></td>
                <td class="text-uppercase fw-bold">{{ orden.vehiculo.placa }}</td>
                <td>{{ orden.vehiculo.marca }} {{ orden.vehiculo.modelo }}</td>
                <td>{{ orden.vehiculo.cliente.nombre }}</td>
                <td>
                    <span class="badge 
                        {% if orden.estado == 'Pendiente' %}bg-warning text-dark
                        {% elif orden.estado == 'En progreso' %}bg-info
                        {% elif orden.estado == 'Completado' %}bg-success
                        {% else %}bg-secondary{% endif %}">
                        {{ orden.estado }}
                    </span>
                </td>
                <td>{{ orden.fecha_creacion.strftime('%d/%m/%Y') }}</td>
                <td>
                    <a href="{{ url_for('detalle_orden', orden_id=orden.id) }}" 
                       class="btn btn-sm btn-primary">Ver / Editar</a>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="7" class="text-center py-4 text-muted">
                    No hay órdenes que coincidan con los filtros actuales
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Paginación -->
{% if paginacion.has_prev or paginacion.has_next %}
<nav aria-label="Paginación de órdenes">
    <ul class="pagination justify-content-center mt-4">
        <li class="page-item {% if not paginacion.has_prev %}disabled{% endif %}">
            <a class="page-link" href="?page={{ paginacion.prev_num }}&estado={{ estado_filtro }}&busqueda={{ busqueda }}">Anterior</a>
        </li>
        {% for p in paginacion.iter_pages(left_edge=2, right_edge=3) %}
            {% if p %}
                <li class="page-item {% if p == paginacion.page %}active{% endif %}">
                    <a class="page-link" href="?page={{ p }}&estado={{ estado_filtro }}&busqueda={{ busqueda }}">{{ p }}</a>
                </li>
            {% else %}
                <li class="page-item disabled"><span class="page-link">…</span></li>
            {% endif %}
        {% endfor %}
        <li class="page-item {% if not paginacion.has_next %}disabled{% endif %}">
            <a class="page-link" href="?page={{ paginacion.next_num }}&estado={{ estado_filtro }}&busqueda={{ busqueda }}">Siguiente</a>
        </li>
    </ul>
</nav>
{% endif %}

<!-- JavaScript para cargar vehículos dinámicamente -->
<script>
function cargarVehiculos(clienteId) {
    const select = document.getElementById('vehiculo_id');
    select.innerHTML = '<option value="">Cargando...</option>';

    if (!clienteId) {
        select.innerHTML = '<option value="">Primero selecciona cliente</option>';
        return;
    }

    fetch(`/vehiculos_por_cliente/${clienteId}`)
        .then(response => response.json())
        .then(data => {
            select.innerHTML = '<option value="">Selecciona vehículo</option>';
            data.forEach(v => {
                const opt = document.createElement('option');
                opt.value = v.id;
                opt.text = `${v.marca} ${v.modelo} — ${v.placa}`;
                select.appendChild(opt);
            });
        })
        .catch(() => {
            select.innerHTML = '<option value="">Error al cargar vehículos</option>';
        }); 
}

// Objeto para guardar daños
let daniosSeleccionados = {};

// Manejar clic en zonas
document.querySelectorAll('.danio-zona').forEach(zona => {
    zona.addEventListener('click', function() {
        const key = this.dataset.zona;

        if (daniosSeleccionados[key]) {
            // Desmarcar
            delete daniosSeleccionados[key];
            this.style.backgroundColor = 'transparent';
            this.style.border = '1px dashed #ccc';
        } else {
            // Marcar
            const obs = prompt(`Observación para ${key.replace('_', ' ').toUpperCase()}:`, '');
            daniosSeleccionados[key] = {
                marcado: true,
                descripcion: obs || 'Daño detectado'
            };
            this.style.backgroundColor = 'rgba(255, 0, 0, 0.5)';
            this.style.border = '2px solid red';
        }

        actualizarLista();
        guardarJson();
    });
});

// Actualizar lista visible
function actualizarLista() {
    const lista = document.getElementById('listaZonas');
    lista.innerHTML = '';

    Object.keys(daniosSeleccionados).forEach(key => {
        const li = document.createElement('li');
        li.className = 'list-group-item d-flex justify-content-between align-items-center';
        li.innerHTML = `
            <span><strong>${key.replace('_', ' ').toUpperCase()}</strong>: ${daniosSeleccionados[key].descripcion}</span>
            <button class="btn btn-sm btn-danger" onclick="quitarDanio('${key}')">Quitar</button>
        `;
        lista.appendChild(li);
    });
}

// Quitar zona
function quitarDanio(key) {
    delete daniosSeleccionados[key];
    document.querySelector(`[data-zona="${key}"]`).style.backgroundColor = 'transparent';
    document.querySelector(`[data-zona="${key}"]`).style.border = '1px dashed #ccc';
    actualizarLista();
    guardarJson();
}

// Guardar como JSON en hidden input
function guardarJson() {
    document.getElementById('danios_zonas_json').value = JSON.stringify(daniosSeleccionados);
}
</script>

{% endblock %}