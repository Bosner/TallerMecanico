{% extends 'base.html' %}
{% block content %}

<h2 class="mb-4">Órdenes de Servicio</h2>

<!-- Dashboard rápido -->
<div class="row mb-4 g-3">
    <div class="col-md-3">
        <div class="card text-white bg-warning shadow-sm">
            <div class="card-body text-center">
                <h5 class="card-title">Pendientes</h5>
                <p class="card-text display-5 fw-bold">{{ total_pendientes }}</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-info shadow-sm">
            <div class="card-body text-center">
                <h5 class="card-title">En Progreso</h5>
                <p class="card-text display-5 fw-bold">{{ total_progreso }}</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-success shadow-sm">
            <div class="card-body text-center">
                <h5 class="card-title">Completadas Hoy</h5>
                <p class="card-text display-5 fw-bold">{{ total_completadas_hoy }}</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-secondary shadow-sm">
            <div class="card-body text-center">
                <h5 class="card-title">Abiertas</h5>
                <p class="card-text display-5 fw-bold">{{ total_abiertas }}</p>
            </div>
        </div>
    </div>
</div>

<!-- Filtros -->
<form method="GET" class="mb-4 border p-3 rounded bg-light">
    <div class="row g-3">
        <div class="col-md-4">
            <label for="estado" class="form-label fw-bold">Estado</label>
            <select class="form-select" id="estado" name="estado">
                <option value="todas" {% if estado_filtro == 'todas' %}selected{% endif %}>Todas</option>
                <option value="Pendiente" {% if estado_filtro == 'Pendiente' %}selected{% endif %}>Pendiente</option>
                <option value="En progreso" {% if estado_filtro == 'En progreso' %}selected{% endif %}>En progreso</option>
                <option value="Completado" {% if estado_filtro == 'Completado' %}selected{% endif %}>Completado</option>
                <option value="Cancelado" {% if estado_filtro == 'Cancelado' %}selected{% endif %}>Cancelado</option>
            </select>
        </div>
        <div class="col-md-6">
            <label for="busqueda" class="form-label fw-bold">Buscar por placa, cliente o folio</label>
            <input type="text" class="form-control" id="busqueda" name="busqueda" 
                   value="{{ busqueda }}" placeholder="Ej: ABC123, Juan Pérez, F-0123">
        </div>
        <div class="col-md-2 d-flex align-items-end">
            <button type="submit" class="btn btn-primary w-100">Filtrar</button>
        </div>
    </div>
</form>

<!-- Botón para crear nueva orden -->
<button class="btn btn-lg btn-success mb-4" type="button" 
        data-bs-toggle="collapse" data-bs-target="#formNuevaOrden" 
        aria-expanded="false" aria-controls="formNuevaOrden">
    + Nueva Orden de Servicio
</button>

<!-- Formulario de creación (colapsado) -->
<div class="collapse mb-5" id="formNuevaOrden">
    <div class="card border-success">
        <div class="card-header bg-success text-white">
            <h5 class="mb-0">Crear Nueva Orden de Servicio</h5>
        </div>
        <div class="card-body">
            <form method="POST">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="cliente_id" class="form-label fw-bold">Cliente *</label>
                        <select class="form-select form-select-lg" id="cliente_id" name="cliente_id" 
                                required onchange="cargarVehiculos(this.value)">
                            <option value="">Selecciona un cliente</option>
                            {% for cliente in clientes %}
                            <option value="{{ cliente.id }}">{{ cliente.nombre }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="vehiculo_id" class="form-label fw-bold">Vehículo *</label>
                        <select class="form-select form-select-lg" id="vehiculo_id" name="vehiculo_id" required>
                            <option value="">Primero selecciona el cliente</option>
                        </select>
                    </div>
                </div>

                <div class="mt-4">
                    <label for="falla_reportada" class="form-label fw-bold">Falla reportada por el cliente *</label>
                    <textarea class="form-control" id="falla_reportada" name="falla_reportada" rows="3" 
                              placeholder="Ej: No enciende, hace ruido al frenar, pierde aceite..." required></textarea>
                </div>

                <div class="mt-4">
                    <label class="form-label fw-bold">Revisión visual inicial (checklist)</label>
                    <div class="row g-3">
                        <div class="col-md-4">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="checklist[]" value="Luces delanteras / traseras" id="chk1">
                                <label class="form-check-label" for="chk1">Luces delanteras / traseras</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="checklist[]" value="Frenos (pastillas / discos)" id="chk2">
                                <label class="form-check-label" for="chk2">Frenos</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="checklist[]" value="Neumáticos (presión / desgaste)" id="chk3">
                                <label class="form-check-label" for="chk3">Neumáticos</label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="checklist[]" value="Niveles (aceite, refrigerante, líquido frenos)" id="chk4">
                                <label class="form-check-label" for="chk4">Niveles de fluidos</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="checklist[]" value="Suspensión / dirección" id="chk5">
                                <label class="form-check-label" for="chk5">Suspensión / dirección</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="checklist[]" value="Batería y bornes" id="chk6">
                                <label class="form-check-label" for="chk6">Batería</label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="checklist[]" value="Escape (ruido / fugas)" id="chk7">
                                <label class="form-check-label" for="chk7">Escape</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="checklist[]" value="Correas y mangueras" id="chk8">
                                <label class="form-check-label" for="chk8">Correas / mangueras</label>
                            </div>
                        </div>
                    </div>
                    <textarea class="form-control mt-3" name="notas_checklist" rows="2" 
                              placeholder="Observaciones adicionales de la revisión visual..."></textarea>
                </div>

                <div class="mt-4">
                    <label for="fecha_compromiso" class="form-label fw-bold">Fecha compromiso de entrega (opcional)</label>
                    <input type="date" class="form-control" id="fecha_compromiso" name="fecha_compromiso">
                </div>

                <div class="mt-4 text-end">
                    <button type="submit" class="btn btn-success btn-lg px-5">Crear Orden</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Tabla de órdenes -->
<div class="table-responsive">
    <table class="table table-striped table-hover">
        <thead class="table-dark">
            <tr>
                <th>Folio</th>
                <th>Placa</th>
                <th>Vehículo</th>
                <th>Cliente</th>
                <th>Estado</th>
                <th>Fecha</th>
                <th>Acción</th>
            </tr>
        </thead>
        <tbody>
            {% for orden in ordenes %}
            <tr>
                <td><strong>{{ orden.folio or 'Sin folio' }}</strong></td>
                <td class="text-uppercase fw-bold">{{ orden.vehiculo.placa }}</td>
                <td>{{ orden.vehiculo.marca }} {{ orden.vehiculo.modelo }}</td>
                <td>{{ orden.vehiculo.cliente.nombre }}</td>
                <td>
                    <span class="badge 
                        {% if orden.estado == 'Pendiente' %}bg-warning text-dark
                        {% elif orden.estado == 'En progreso' %}bg-info
                        {% elif orden.estado == 'Completado' %}bg-success
                        {% else %}bg-secondary{% endif %}">
                        {{ orden.estado }}
                    </span>
                </td>
                <td>{{ orden.fecha_creacion.strftime('%d/%m/%Y') }}</td>
                <td>
                    <a href="{{ url_for('detalle_orden', orden_id=orden.id) }}" 
                       class="btn btn-sm btn-primary">Ver / Editar</a>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="7" class="text-center py-4 text-muted">
                    No hay órdenes que coincidan con los filtros actuales
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Paginación -->
{% if paginacion.has_prev or paginacion.has_next %}
<nav aria-label="Paginación de órdenes">
    <ul class="pagination justify-content-center mt-4">
        <li class="page-item {% if not paginacion.has_prev %}disabled{% endif %}">
            <a class="page-link" href="?page={{ paginacion.prev_num }}&estado={{ estado_filtro }}&busqueda={{ busqueda }}">Anterior</a>
        </li>
        {% for p in paginacion.iter_pages(left_edge=2, right_edge=3) %}
            {% if p %}
                <li class="page-item {% if p == paginacion.page %}active{% endif %}">
                    <a class="page-link" href="?page={{ p }}&estado={{ estado_filtro }}&busqueda={{ busqueda }}">{{ p }}</a>
                </li>
            {% else %}
                <li class="page-item disabled"><span class="page-link">…</span></li>
            {% endif %}
        {% endfor %}
        <li class="page-item {% if not paginacion.has_next %}disabled{% endif %}">
            <a class="page-link" href="?page={{ paginacion.next_num }}&estado={{ estado_filtro }}&busqueda={{ busqueda }}">Siguiente</a>
        </li>
    </ul>
</nav>
{% endif %}

<!-- JavaScript para cargar vehículos dinámicamente -->
<script>
function cargarVehiculos(clienteId) {
    const select = document.getElementById('vehiculo_id');
    select.innerHTML = '<option value="">Cargando...</option>';

    if (!clienteId) {
        select.innerHTML = '<option value="">Primero selecciona cliente</option>';
        return;
    }

    fetch(`/vehiculos_por_cliente/${clienteId}`)
        .then(response => response.json())
        .then(data => {
            select.innerHTML = '<option value="">Selecciona vehículo</option>';
            data.forEach(v => {
                const opt = document.createElement('option');
                opt.value = v.id;
                opt.text = `${v.marca} ${v.modelo} — ${v.placa}`;
                select.appendChild(opt);
            });
        })
        .catch(() => {
            select.innerHTML = '<option value="">Error al cargar vehículos</option>';
        });
}
</script>

{% endblock %}