{% extends 'base.html' %}
{% block content %}

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Orden de Servicio #{{ orden.folio or orden.id }}</h2>
        <a href="{{ url_for('ordenes_servicio') }}" class="btn btn-secondary">← Volver al listado</a>
    </div>

    <!-- Tarjeta principal - Información general -->
    <div class="card shadow mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">Información General</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <p><strong>Cliente:</strong> {{ orden.vehiculo.cliente.nombre }}</p>
                    <p><strong>Vehículo:</strong> {{ orden.vehiculo.marca }} {{ orden.vehiculo.modelo }}</p>
                    <p><strong>Placa:</strong> <strong class="text-uppercase">{{ orden.vehiculo.placa }}</strong></p>
                    <p><strong>Año:</strong> {{ orden.vehiculo.ano }}</p>
                    {% if orden.vehiculo.kms_actual %}
                    <p><strong>Kms actuales:</strong> {{ orden.vehiculo.kms_actual | default('-') }}</p>
                    {% endif %}
                </div>
                <div class="col-md-6">
                    <p><strong>Fecha creación:</strong> {{ orden.fecha_creacion.strftime('%d/%m/%Y %H:%M') }}</p>
                    {% if orden.fecha_compromiso %}
                    <p><strong>Fecha compromiso entrega:</strong> {{ orden.fecha_compromiso.strftime('%d/%m/%Y') }}</p>
                    {% endif %}
                    {% if orden.fecha_entrega %}
                    <p><strong>Fecha entrega real:</strong> {{ orden.fecha_entrega.strftime('%d/%m/%Y') }}</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Falla reportada -->
    <div class="card shadow mb-4">
        <div class="card-header bg-danger text-white">
            <h5 class="mb-0">Falla reportada por el cliente</h5>
        </div>
        <div class="card-body">
            <p class="lead">{{ orden.falla_reportada | safe | default('No se registró falla reportada') }}</p>
        </div>
    </div>

    <!-- Checklist revisión visual -->
    <div class="card shadow mb-4">
        <div class="card-header bg-warning text-dark fw-bold">Revisión Física Inicial</div>
        <div class="card-body">
            {% if orden.checklist_revision %}
            <ul class="list-group list-group-flush">
                {% for key, data in orden.checklist_revision.items() %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <span>{{ checklist_items|selectattr('key', 'equalto', key)|map(attribute='label')|first }}</span>
                    <span>
                        {% if data.si %}
                        <span class="badge bg-success">SI</span>
                        {% else %}
                        <span class="badge bg-danger">NO</span>
                        {% endif %}
                        {% if data.obs %}
                        <small class="text-muted ms-2">({{ data.obs }})</small>
                        {% endif %}
                    </span>
                </li>
                {% endfor %}
            </ul>
            {% else %}
            <p class="text-muted">No se registró revisión inicial.</p>
            {% endif %}
        </div>
    </div>

    <!-- Trabajo realizado (editable solo en progreso o completado) -->
    <div class="card shadow mb-4">
        <div class="card-header bg-info text-white">
            <h5 class="mb-0">Trabajo realizado</h5>
        </div>
        <div class="card-body">
            {% if orden.estado in ['En progreso', 'Completado'] %}
            <form method="POST" action="{{ url_for('update_trabajo_realizado', orden_id=orden.id) }}">
                <textarea class="form-control mb-3" name="trabajo_realizado" rows="5" 
                          placeholder="Describe aquí el servicio realizado, reparaciones, ajustes, diagnóstico, etc...">
{{ orden.trabajo_realizado or '' }}</textarea>
                <button type="submit" class="btn btn-primary">Guardar descripción del trabajo</button>
            </form>
            {% else %}
            <div class="alert alert-secondary mb-0">
                El campo "Trabajo realizado" se habilita cuando la orden pasa a "En progreso".
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Refacciones / Materiales utilizados -->
    <div class="card shadow mb-4">
        <div class="card-header bg-secondary text-white">
            <h5 class="mb-0">Refacciones / Materiales utilizados</h5>
        </div>
        <div class="card-body">

            <!-- Formulario para agregar refacción (solo en progreso) -->
            {% if orden.estado == 'En progreso' %}
            <form method="POST" action="{{ url_for('agregar_refaccion_orden', orden_id=orden.id) }}" class="mb-4 border p-3 rounded bg-light">
                <div class="row g-3 align-items-end">
                    <div class="col-md-5">
                        <label for="parte_id" class="form-label fw-bold">Seleccionar refacción del inventario</label>
                        <select class="form-select" id="parte_id" name="parte_id" required>
                            <option value="">-- Selecciona una pieza --</option>
                            {% for parte in partes_disponibles %}
                            <option value="{{ parte.id }}">{{ parte.nombre_parte }} (stock disponible: {{ parte.cantidad }})</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="cantidad_usada" class="form-label fw-bold">Cantidad</label>
                        <input type="number" class="form-control" name="cantidad_usada" min="1" value="1" required>
                    </div>
                    <div class="col-md-4">
                        <button type="submit" class="btn btn-success w-100">+ Agregar refacción</button>
                    </div>
                </div>
            </form>
            {% endif %}

            <!-- Tabla de refacciones ya usadas -->
            {% if orden.partes|length > 0 %}
            <div class="table-responsive">
                <table class="table table-sm table-bordered table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>Refacción</th>
                            <th class="text-center">Cantidad usada</th>
                            <th class="text-center">Acción</th> <!-- opcional, por si quieres eliminar después -->
                        </tr>
                    </thead>
                    <tbody>
                        {% for parte in orden.partes %}
                        <tr>
                            <td>{{ parte.nombre_parte }}</td>
                            <td class="text-center fw-bold">
                                {{ cantidades_usadas.get(parte.id, 0) }}
                            </td>
                            <td class="text-center">
                                <!-- Puedes agregar botón de eliminar más adelante -->
                                <small class="text-muted">Agregado en esta orden</small>
                            </td>
                        </tr>
                        {% endfor %}
                        <tr class="table-info">
                            <td colspan="2" class="text-end fw-bold">Total piezas usadas:</td>
                            <td class="text-center fw-bold">{{ total_piezas_usadas }}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="alert alert-info mb-0">
                {% if orden.estado == 'En progreso' %}
                Aún no se han agregado refacciones a esta orden.
                {% else %}
                No se registraron refacciones (o la orden no está en progreso).
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Cambio de estado -->
    <div class="card shadow border-primary">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">
                Estado actual: 
                <span class="badge bg-light text-dark ms-2 fs-6">{{ orden.estado }}</span>
            </h5>
        </div>
        <div class="card-body">
            <form method="POST" action="{{ url_for('update_estado_orden', orden_id=orden.id) }}">
                <div class="row g-3 align-items-center">
                    <div class="col-md-5">
                        <select class="form-select form-select-lg" name="estado" required>
                            <option value="Pendiente"    {% if orden.estado == 'Pendiente'    %}selected{% endif %}>Pendiente</option>
                            <option value="En progreso"  {% if orden.estado == 'En progreso'  %}selected{% endif %}>En progreso</option>
                            <option value="Completado"   {% if orden.estado == 'Completado'   %}selected{% endif %}>Completado</option>
                            <option value="Cancelado"    {% if orden.estado == 'Cancelado'    %}selected{% endif %}>Cancelado</option>
                        </select>
                    </div>
                    <div class="col-md-7">
                        <button type="submit" class="btn btn-primary btn-lg w-100">
                            Actualizar Estado
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}